<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <title>TINA</title>
    <style>
        body { 
            font-family: Arial; 
            margin: 0;
            background: #f9f9f9;
            overflow: hidden;
        }

        /* –õ–µ–π–∞—É—Ç 2 –ø–∞–Ω–µ–ª–∏ */
        .layout {
            display: flex;
            height: 100vh;
        }

        /* ===== –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ ‚Äî –ß–ê–¢ (—Ç–≤–æ–π –∏—Å—Ö–æ–¥–Ω—ã–π —Å—Ç–∏–ª—å) ===== */
        .chat-container {
            width: 50%;
            padding: 30px;
            overflow-y: visible;
            background: #f9f9f9;
        }

        #chat-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            height: calc(100vh - 300px);
            overflow-y: auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .msg {
            margin: 10px 0;
            padding: 8px 12px;
            border-radius: 6px;
            max-width: 80%;
            white-space: pre-wrap;
        }

        .user {
            background: #dce9ff;
            text-align: right;
            margin-left: 20%;
        }

        .bot {
            background: #e4ffe4;
            text-align: left;
        }

        .status-box {
            background: #fff3cd;
            border-left: 4px solid #ffca2c;
            padding: 10px;
            margin-top: 10px;
        }

        /* ===== –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ ‚Äî –°–¢–†–ò–ú ===== */
        .stream-container {
            width: 50%;
            padding: 30px;
            overflow-y: auto;
            background: #ffffff;
            border-left: 2px solid #ddd;
        }

        .stream-item {
            background: #f7f7f7;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }

        .stream-image {
            max-width: 100%;
            border-radius: 10px;
        }

        /* ===== INPUT PANEL ===== */
        .input-row {
            position: fixed;
            bottom: 20px;
            left: 30px;
            width: calc(50% - 60px);
            display: flex;
            gap: 10px;
        }

        .input-row input {
            width: 80%;
            padding: 8px;
            font-size: 16px;
        }
        .input-row button {
            padding: 8px 16px;
            font-size: 16px;
        }
        .input-row button:disabled {
            background: #aaa;
            cursor: not-allowed;
        }
    </style>
</head>

<body>

<div class="layout">

    <!-- ---------------- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ ‚Äî –ß–ê–¢ ---------------- -->
    <div class="chat-container">

        <h2>üõçÔ∏è TINA - T-Intelligent assistant (Shopping) </h2>

        <!-- –ü–†–û–ö–†–£–ß–ò–í–ê–ï–ú–´–ô –ë–õ–û–ö -->
        <div id="chat-box" class="chat-scroll"></div>

        <div class="status-box" id="status-box">
            <b>–°—Ç–∞—Ç—É—Å:</b>
            <span id="status-text">–æ–∂–∏–¥–∞–Ω–∏–µ...</span>
        </div>

    </div>

    <!-- ---------------- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ ‚Äî –°–¢–†–ò–ú ---------------- -->
    <div class="stream-container">
        <h2>üì° –ü–æ—Ç–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</h2>
        <div id="stream-box"></div>
    </div>

</div>

<!-- ===== –§–ò–ö–°–ò–†–û–í–ê–ù–ù–ê–Ø –ü–ê–ù–ï–õ–¨ –í–í–û–î–ê ===== -->
<div class="input-row">
    <input id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
    <button id="send-btn" onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>


<script>
/* ------------- –¢–í–û–ô JS –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô -------------- */
let userId = null;

function addMessage(sender, text) {
    const div = document.createElement("div");
    div.className = "msg " + sender;
    div.innerText = text;
    document.getElementById("chat-box").appendChild(div);

    // –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
    const box = document.getElementById("chat-box");
    box.scrollTop = box.scrollHeight;
}

function updateStatus(intentReply) {
    const status = intentReply.type;
    document.getElementById("status-text").innerText = status;

    if (status === "final") {
        document.getElementById("send-btn").disabled = true;
        document.getElementById("input").disabled = true;
        addMessage("bot", "üîç –ü–æ–∏—Å–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤... –û–∂–∏–¥–∞–π—Ç–µ.");
        runStream();
    }
}

async function send() {
    const btn = document.getElementById("send-btn");
    const input = document.getElementById("input");
    const text = input.value;

    if (!text) return;

    addMessage("user", text);
    input.value = "";
    btn.disabled = true;

    const res = await fetch("http://localhost:8000/chat", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ user_id: userId, text })
    });

    const data = await res.json();
    userId = data.user_id;

    updateStatus(data.reply);

    let replyText = "";

    if (data.reply.type === "clarification") {
        replyText = "ü§ñ –£—Ç–æ—á–Ω–µ–Ω–∏–µ: " + data.reply.question;
    } 
    else if (data.reply.type === "not_relevant") {
        replyText = "‚ö†Ô∏è –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ: " + data.reply.message;
    }
    else if (data.reply.type === "final") {
        replyText = "üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:\n" +
                    JSON.stringify(data.reply.products, null, 2);
    } 
    else {
        replyText = JSON.stringify(data.reply, null, 2);
    }

    addMessage("bot", replyText);

    if (data.reply.type !== "final") {
        btn.disabled = false;
    }
}

function addStreamText(text) {
    const div = document.createElement("div");
    div.className = "stream-item";
    div.innerText = text;
    document.getElementById("stream-box").appendChild(div);
}

async function runStream() {
    console.log("‚ñ∂Ô∏è runStream start, user:", userId);

    const resp = await fetch("http://localhost:8000/chat/stream", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ user_id: userId })
    });

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();

    // —Ç–µ–∫—É—â–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
    let currentCard = null;
    let currentGallery = null;
    let currentTextBlock = null;

    while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        const lines = chunk.split("\n").filter(x => x.trim().length > 0);

        for (const line of lines) {
            let event;
            try { event = JSON.parse(line); }
            catch { continue; }

            console.log("STREAM EVENT:", event);

            /* ---------------- START_PRODUCT ---------------- */
            if (event.event === "start_product") {
                const card = document.createElement("div");
                card.className = "product-card";

                const title = document.createElement("div");
                title.className = "product-title";
                title.innerText = "üõí " + (event.product.title || event.product);

                const gallery = document.createElement("div");
                gallery.className = "product-gallery";

                const textBlock = document.createElement("div");
                textBlock.className = "product-text";
                textBlock.innerText = "";

                card.appendChild(title);
                card.appendChild(gallery);
                card.appendChild(textBlock);

                document.getElementById("stream-box").appendChild(card);

                currentCard = card;
                currentGallery = gallery;
                currentTextBlock = textBlock;
            }

            /* ---------------- IMAGE ---------------- */
            else if (event.event === "image") {
                if (currentGallery) {
                    const img = document.createElement("img");
                    img.src = event.url;
                    currentGallery.appendChild(img);
                }
            }

            /* ---------------- TEXT ---------------- */
            else if (event.event === "text") {
                if (currentTextBlock) {
                    currentTextBlock.innerText += event.content + "\n\n";
                }
            }

            /* ---------------- END_PRODUCT ---------------- */
            else if (event.event === "end_product") {
                if (currentCard) {
                    currentCard.style.border = "2px solid #4caf50";
                }
            }

            /* ---------------- NEED_CLARIFICATION ---------------- */
            else if (event.event === "need_clarification") {

                addStreamText("üü® –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–æ—á–Ω–µ–Ω–∏–µ. –ü–æ–∫–∞–∑–∞–Ω—ã 3 –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.");

                // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –≤ —Å—Ç—Ä–∏–º-–ø–∞–Ω–µ–ª—å
                const box = document.getElementById("stream-box");

                const clar = document.createElement("div");
                clar.className = "stream-item";
                clar.innerHTML = "<b>–ù—É–∂–Ω—ã —É—Ç–æ—á–Ω–µ–Ω–∏—è. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä:</b>";

                for (const c of event.candidates) {
                    const btn = document.createElement("button");
                    btn.style.margin = "8px";
                    btn.innerText = c.product.title || c.product;

                    btn.onclick = () => {
                        console.log("–í—ã–±—Ä–∞–Ω –∫–∞–Ω–¥–∏–¥–∞—Ç:", c);
                        // TODO –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä –≤ —á–∞—Ç (/chat)
                    };

                    clar.appendChild(btn);
                }

                box.appendChild(clar);

                return; // ‚õî —Å—Ç–æ–ø —Å—Ç—Ä–∏–º–∞, –∂–¥—ë–º —É—Ç–æ—á–Ω–µ–Ω–∏—è
            }

            /* ---------------- –í–°–ï –ì–û–¢–û–í–û ---------------- */
            else if (event.event === "all_done") {
                addStreamText("üéâ –í—Å–µ —Ç–æ–≤–∞—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã.");
                return;
            }
        }
    }
}


</script>
</body>
</html>
