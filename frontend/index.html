<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <title>TINA</title>
    <style>
        body { 
            font-family: Arial; 
            margin: 0;
            background: #f9f9f9;
            overflow: hidden;
        }

        .layout {
            display: flex;
            height: 100vh;
        }

        /* ===== –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ ‚Äî –ß–ê–¢ ===== */
        .chat-container {
            width: 50%;
            padding: 30px;
            overflow-y: visible;
            background: #f9f9f9;
        }

        #chat-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            height: calc(100vh - 300px);
            overflow-y: auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .msg {
            margin: 10px 0;
            padding: 8px 12px;
            border-radius: 6px;
            max-width: 80%;
            white-space: pre-wrap;
        }

        .user {
            background: #dce9ff;
            text-align: right;
            margin-left: 20%;
        }

        .bot {
            background: #e4ffe4;
            text-align: left;
        }

        .status-box {
            background: #fff3cd;
            border-left: 4px solid #ffca2c;
            padding: 10px;
            margin-top: 10px;
        }

        /* ===== –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ ‚Äî –°–¢–†–ò–ú ===== */
        .stream-container {
            width: 50%;
            padding: 30px;
            background: #ffffff;
            border-left: 2px solid #ddd;

            display: flex;
            flex-direction: column;
            gap: 20px;

            overflow-y: auto;
        }


        /* ===== INPUT PANEL ===== */
        .input-row {
            position: fixed;
            bottom: 20px;
            left: 30px;
            width: calc(50% - 60px);
            display: flex;
            gap: 10px;
        }

        .input-row input {
            width: 80%;
            padding: 8px;
            font-size: 16px;
        }
        .input-row button {
            padding: 8px 16px;
            font-size: 16px;
        }
        .input-row button:disabled {
            background: #aaa;
            cursor: not-allowed;
        }

        /* –û–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–µ–∫—Ü–∏–π (—Ç–µ–∫—Å—Ç/—Ñ–æ—Ç–æ) */
        .stream-section {
            display: flex;
            flex-direction: column;
            flex: 1;

            background: #f5f7fb;                 /* –º—è–≥–∫–∏–π —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω */
            border: 1px solid #e1e5ee;           /* —Ç–æ–Ω–∫–∞—è —Ä–∞–º–∫–∞ */
            border-radius: 12px;
            padding: 15px 18px;
            margin-bottom: 200px;

            box-shadow: 0 4px 10px rgba(0,0,0,0.05);   /* –º—è–≥–∫–∞—è —Ç–µ–Ω—å */
        }

        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ—Ç–æ–∫–æ–≤ */
        .stream-section h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-weight: 600;
        }

        /* –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º—ã–µ –∑–æ–Ω—ã */
        #stream-text.stream-box {
            height: 25vh;           /* üí° –≠–¢–û –í–ö–õ–Æ–ß–ê–ï–¢ –°–ö–†–û–õ–õ */
            overflow-y: auto;
            background: white;
            border-radius: 10px;
            padding: 10px;
            border: 1px solid #ccc;
        }

        /* –≠–ª–µ–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞ */
        .stream-item {
            background: #eef4ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* –§–æ—Ç–æ */
        .stream-image {
            width: 100%;
            max-width: 100%;
            border-radius: 12px;
            margin-bottom: 10px;

            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }

        button:disabled {
            background: #ccc !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }

    </style>
</head>

<body>

<div class="layout">

    <!-- ---------------- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ ‚Äî –ß–ê–¢ ---------------- -->
    <div class="chat-container">

        <h2>üõçÔ∏è TINA - T-Intelligent assistant </h2>

        <div id="chat-box" class="chat-scroll"></div>

        <div class="status-box" id="status-box">
            <b>–°—Ç–∞—Ç—É—Å:</b>
            <span id="status-text">–æ–∂–∏–¥–∞–Ω–∏–µ...</span>
        </div>

    </div>

    <!-- ---------------- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ ‚Äî –°–¢–†–ò–ú ---------------- -->
    <div class="stream-container">
        <h2>üì° Stream</h2>

        <!-- –ë–ª–æ–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π -->
        <h3>–≠–∫—Ä–∞–Ω</h3>
        <div id="stream-photo"></div>


        <!-- –ë–ª–æ–∫ —Ç–µ–∫—Å—Ç–∞ -->
        <div class="stream-section">
            <h3>–ü–æ—Ç–æ–∫ –º—ã—Å–ª–µ–π</h3>
            <div id="stream-text" class="stream-box"></div>
    </div>

</div>


</div>

<!-- ===== –§–ò–ö–°–ò–†–û–í–ê–ù–ù–ê–Ø –ü–ê–ù–ï–õ–¨ –í–í–û–î–ê ===== -->
<div class="input-row">
    <input id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
    <input id="image-upload" type="file" accept="image/*" />
    <button id="send-btn" onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>    
</div>


<script>
let userId = "user_1";
let currentThoughtDiv = null;
let selectedCandidates = [];


function addMessage(sender, text) {
    const div = document.createElement("div");
    div.className = "msg " + sender;
    div.innerText = text;
    document.getElementById("chat-box").appendChild(div);

    // –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
    const box = document.getElementById("chat-box");
    box.scrollTop = box.scrollHeight;
}


function updateStatus(intentReply) {
    const status = intentReply.type;
    document.getElementById("status-text").innerText = status;

    if (status === "final") {
        document.getElementById("send-btn").disabled = true;
        document.getElementById("input").disabled = true;
        addMessage("bot", "üîç –ü–æ–∏—Å–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤... –û–∂–∏–¥–∞–π—Ç–µ.");
        runStream();
    }
}


async function send() {
    const btn = document.getElementById("send-btn");
    const input = document.getElementById("input");
    const fileInput = document.getElementById("image-upload");

    const text = input.value.trim();
    const file = fileInput.files[0];

    if (!text && !file) return;

    let finalPayload = text;
    let base64Image = null;

    // =============================
    // –î–û–ë–ê–í–õ–Ø–ï–ú –ö–ê–†–¢–ò–ù–ö–£ –ï–°–õ–ò –ï–°–¢–¨
    // =============================
    if (file) {
        base64Image = await fileToBase64(file);
        finalPayload += "\n" + base64Image;

        // üëâ –ù–ê–î–û –î–û–ë–ê–í–ò–¢–¨
        addMessage("bot", "–§–∏—á–∞ –≤ —Ä–∞–±–æ—Ç–µ. –î–æ–¥–µ–ª–∞–µ–º —É–∂–µ –Ω–∞ —Ä–∞–±–æ—Ç–µ!");

    }


    // ----------------------------
    // –ü–û–ö–ê–ó–´–í–ê–ï–ú –°–û–û–ë–©–ï–ù–ò–ï –í –ß–ê–¢–ï
    // ----------------------------
    addUserMessage(text, base64Image);

    input.value = "";
    fileInput.value = "";
    btn.disabled = true;

    // =============================
    // –†–ï–ñ–ò–ú –£–¢–û–ß–ù–ï–ù–ò–Ø
    // =============================
    if (window.awaitingClarification === true) {

        addMessage("bot", "üîç –£—Ç–æ—á–Ω—è—é –∑–∞–ø—Ä–æ—Å...");

        const resp = await fetch("http://localhost:9213/agent/clarify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                user_id: userId,
                query: finalPayload
            })
        });

        runClarifyStream(resp);
        return;
    }

    // =============================
    // –û–°–ù–û–í–ù–û–ô –ó–ê–ü–†–û–°
    // =============================
    const res = await fetch("http://localhost:9213/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            user_id: userId,
            text: finalPayload
        })
    });

    const data = await res.json();

    updateStatus(data.reply);

    let replyText = "";

    if (data.reply.type === "clarification") {
        replyText = "ü§ñ –£—Ç–æ—á–Ω–µ–Ω–∏–µ: " + data.reply.question;
    }
    else if (data.reply.type === "not_relevant") {
        replyText = "‚ö†Ô∏è –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ: " + data.reply.message;
    }
    else if (data.reply.type === "final") {
        const products = data.reply.products || [];

        let output = "üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:\n\n";

        products.forEach((product, index) => {
            output += `–¢–æ–≤–∞—Ä ${index + 1}: ${product.name}\n`;

            const attrsObj = product.attributes || {};
            const filled = Object.entries(attrsObj)
                .filter(([_, val]) => val && String(val).trim() !== "");

            if (filled.length > 0) {
                output += "–ê—Ç—Ä–∏–±—É—Ç—ã:\n";
                filled.forEach(([k, v]) => {
                    output += `‚Ä¢ ${k}: ${v}\n`;
                });
            }

            output += "\n";
        });

        replyText = output;
    }
    else {
        replyText = JSON.stringify(data.reply, null, 2);
    }

    addMessage("bot", replyText);

    if (data.reply.type !== "final") {
        btn.disabled = false;
    }
}


// ========== –ü–û–ö–ê–ó –ö–ê–†–¢–ò–ù–ö–ò –í –ß–ê–¢–ï =============

function addUserMessage(text, base64Image) {
    const box = document.getElementById("chat-box");

    const div = document.createElement("div");
    div.className = "msg user";

    // –§–æ—Ä–º–∏—Ä—É–µ–º HTML —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    let html = "";
    if (text) html += text + "<br>";

    if (base64Image) {
        html += `<img src="${base64Image}" 
                      style="max-width:150px;
                             margin-top:8px;
                             border-radius:8px;
                             display:block;">`;
    }

    div.innerHTML = html;

    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}


// === –£–¢–ò–õ–ò–¢–ê: file -> base64 ===
function fileToBase64(file) {
    return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
    });
}


function addStreamText(chunk) {
    const box = document.getElementById("stream-text");
    const text = chunk ?? "";

    if (text.trim() === "") {
        currentThoughtDiv = null;
        return;
    }

    if (!currentThoughtDiv) {
        currentThoughtDiv = document.createElement("div");
        currentThoughtDiv.className = "stream-item";
        box.appendChild(currentThoughtDiv);
    }

    currentThoughtDiv.innerText = text;

    box.scrollTop = box.scrollHeight;
}


function addStreamPhoto(url) {
    const box = document.getElementById("stream-photo");

    box.innerHTML = "";

    const img = document.createElement("img");
    img.className = "stream-image";
    img.src = url;

    box.appendChild(img);
}


async function runStream() {

    addStreamText("‚è≥ –°—Ç—Ä–∏–º –∑–∞–ø—É—â–µ–Ω. –ñ–¥—ë–º –∞–≥–µ–Ω—Ç–∞...");

    const resp = await fetch("http://localhost:9213/agent/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId })
    });

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();

    let buffer = "";

    while (true) {

        const { value, done } = await reader.read();

        if (done) {
            addStreamText("‚èπ –°—Ç—Ä–∏–º –∑–∞–≤–µ—Ä—à—ë–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.");
            break;
        }

        buffer += decoder.decode(value, { stream: true });

        let lines = buffer.split("\n");
        buffer = lines.pop();

        for (let line of lines) {

            if (!line.trim()) continue;

            let event;
            try {
                event = JSON.parse(line);
            } catch (err) {
                addStreamText("‚ö† –ü–ª–æ—Ö–æ–π JSON: " + line);
                continue;
            }

            if (event.type === "text") {
                addStreamText(event.content);
            }

            else if (event.type === "image") {
                addStreamPhoto(event.content);

            }

            else if (event.type === "products") {
                console.log("üì¶ RAW PRODUCTS:", event.items);

                addMessage("bot", "üì¶ –ö–∞–Ω–¥–∏–¥–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã!");

                const urls = event.items;

                const items = urls.map((url, idx) => ({
                    id: idx + 1,
                    url: url
                }));

                showCandidatesFromAgent(items);
            }

        }
    }
}


function disableCandidateButtons() {
    const buttons = document.querySelectorAll(".candidate-btn");
    buttons.forEach(btn => {
        btn.disabled = true;
        btn.style.pointerEvents = "none";  // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    });
}


async function selectCandidate(id) {
    disableCandidateButtons();

    // –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä –ø–æ –µ–≥–æ id (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã)
    const lastShown = window.lastCandidates || [];
    const selected = lastShown.find(c => c.id === id);

    if (selected) {
        selectedCandidates.push(selected);
        console.log("üß∫ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É:", selectedCandidates);
    }

    addMessage("user", `–í—ã–±–∏—Ä–∞—é —Ç–æ–≤–∞—Ä #${id}`);

    const resp = await fetch("http://localhost:9213/agent/next", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId })
    });

    // –ö–ê–ù–î–ò–î–ê–¢–´ –ó–ê–ö–û–ù–ß–ò–õ–ò–°–¨
    if (!resp.ok) {
        addMessage("bot", "‚ùå –¢–æ–≤–∞—Ä—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å");

        showCart();      // <==== –≤—ã–≤–æ–¥–∏–º –∫–æ—Ä–∑–∏–Ω—É

        selectedCandidates = [];  // –º–æ–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
        return;
    }

    // –æ—á–∏—â–∞–µ–º –ø–æ—Ç–æ–∫
    document.getElementById("stream-text").innerHTML = "";
    document.getElementById("stream-photo").innerHTML = "";
    currentThoughtDiv = null;

    runNextStream(resp);
}


function showCart() {
    const box = document.getElementById("chat-box");

    const div = document.createElement("div");
    div.className = "msg bot";
    div.style.background = "#e4ffe4";
    div.style.padding = "15px";
    div.style.borderRadius = "8px";
    div.style.marginTop = "15px";

    if (selectedCandidates.length === 0) {
        div.innerHTML = "<b>üß∫ –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</b>";
        box.appendChild(div);
        return;
    }

    let html = "<b>üß∫ –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞:</b><br><br>";

    selectedCandidates.forEach((item, index) => {
        html += `
            <b>${index + 1}. –¢–æ–≤–∞—Ä</b><br>
            üîó <a href="${item.url}" target="_blank">${item.url}</a><br><br>
        `;
    });

    div.innerHTML = html;
    box.appendChild(div);

    box.scrollTop = box.scrollHeight;
}


function rejectAll() {
    disableCandidateButtons();

    addMessage("user", "–ú–Ω–µ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–æ—à–ª–æ.");
    addMessage("bot", "üìù –•–æ—Ä–æ—à–æ. –£—Ç–æ—á–Ω–∏—Ç–µ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å.");

    document.getElementById("input").disabled = false;
    document.getElementById("send-btn").disabled = false;
    document.getElementById("input").focus();

    window.awaitingClarification = true;
}

function showCandidatesFromAgent(items) {
    window.lastCandidates = items;

    items.forEach((item, index) => {
        const id = index + 1;

        const div = document.createElement("div");
        div.className = "msg bot";
        div.style.background = "#eef7ff";
        div.style.padding = "12px";
        div.style.borderRadius = "8px";
        div.style.margin = "10px 0";

        div.innerHTML = `
            <b>–¢–æ–≤–∞—Ä #${id}</b><br>
            üîó <a href="${item.url}" target="_blank">${item.url}</a><br><br>

            <button class="candidate-btn"
                    onclick="selectCandidate(${id})"
                    style="padding:8px 12px;border-radius:6px;cursor:pointer;">
                –í—ã–±—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä #${id}
            </button>
        `;

        document.getElementById("chat-box").appendChild(div);
    });

    // –ö–Ω–æ–ø–∫–∞ "–Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–æ—à–ª–æ"
    const rejectDiv = document.createElement("div");
    rejectDiv.className = "msg bot";
    rejectDiv.style.background = "#ffecec";
    rejectDiv.style.padding = "12px";
    rejectDiv.style.borderRadius = "8px";

    rejectDiv.innerHTML = `
        <button id="reject-btn"
            class="candidate-btn"
            style="background:#ff4d4d;color:white;padding:8px 14px;border:none;
                   border-radius:6px;cursor:pointer;">
            ‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–æ—à–ª–æ
        </button>
    `;

    // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    rejectDiv.querySelector("#reject-btn").onclick = rejectAll;

    document.getElementById("chat-box").appendChild(rejectDiv);
}


async function runClarifyStream(resp) {

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buffer = "";

    while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });

        let lines = buffer.split("\n");
        buffer = lines.pop();

        for (let line of lines) {
            if (!line.trim()) continue;

            let event;
            try { event = JSON.parse(line); }
            catch { continue; }

            if (event.type === "text") {
                addMessage("bot", event.content);
            }

            if (event.type === "candidates") {
                showCandidates(event.items); // <-- –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                window.awaitingClarification = false;
            }
        }
    }

    document.getElementById("send-btn").disabled = false;
}


async function runNextStream(resp) {

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();

    let buffer = "";

    while (true) {

        const { value, done } = await reader.read();

        if (done) {
            addStreamText("‚èπ –°—Ç—Ä–∏–º –∑–∞–≤–µ—Ä—à—ë–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.");
            break;
        }

        buffer += decoder.decode(value, { stream: true });

        let lines = buffer.split("\n");
        buffer = lines.pop();


        for (let line of lines) {
            if (!line.trim()) continue;

            let event;
            try {
                event = JSON.parse(line);
            } catch (err) {
                addStreamText("‚ö† –ü–ª–æ—Ö–æ–π JSON: " + line);
                continue;
            }
            console.log("NEXT EVENT:", event);

            if (event.type === "text") {
                addStreamText(event.content);
            }

            else if (event.type === "image") {
                addStreamPhoto(event.content);

            }

            else if (event.type === "products") {
                console.log("üì¶ RAW PRODUCTS:", event.items);

                addMessage("bot", "üì¶ –ö–∞–Ω–¥–∏–¥–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã!");

                const urls = event.items;

                const items = urls.map((url, idx) => ({
                    id: idx + 1,
                    url: url
                }));

                showCandidatesFromAgent(items);
            }
        }
    }
}


</script>
</body>
</html>
