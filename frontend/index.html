<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <title>TINA</title>
    <style>
        body { 
            font-family: Arial; 
            margin: 0;
            background: #f9f9f9;
            overflow: hidden;
        }

        /* –õ–µ–π–∞—É—Ç 2 –ø–∞–Ω–µ–ª–∏ */
        .layout {
            display: flex;
            height: 100vh;
        }

        /* ===== –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ ‚Äî –ß–ê–¢ (—Ç–≤–æ–π –∏—Å—Ö–æ–¥–Ω—ã–π —Å—Ç–∏–ª—å) ===== */
        .chat-container {
            width: 50%;
            padding: 30px;
            overflow-y: visible;
            background: #f9f9f9;
        }

        #chat-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            height: calc(100vh - 300px);
            overflow-y: auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .msg {
            margin: 10px 0;
            padding: 8px 12px;
            border-radius: 6px;
            max-width: 80%;
            white-space: pre-wrap;
        }

        .user {
            background: #dce9ff;
            text-align: right;
            margin-left: 20%;
        }

        .bot {
            background: #e4ffe4;
            text-align: left;
        }

        .status-box {
            background: #fff3cd;
            border-left: 4px solid #ffca2c;
            padding: 10px;
            margin-top: 10px;
        }

        /* ===== –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ ‚Äî –°–¢–†–ò–ú ===== */
        .stream-container {
            width: 50%;
            padding: 30px;
            background: #ffffff;
            border-left: 2px solid #ddd;

            display: flex;
            flex-direction: column;
            gap: 20px;
        }


        .stream-item {
            background: #f7f7f7;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }

        .stream-image {
            max-width: 100%;
            border-radius: 10px;
        }

        /* ===== INPUT PANEL ===== */
        .input-row {
            position: fixed;
            bottom: 20px;
            left: 30px;
            width: calc(50% - 60px);
            display: flex;
            gap: 10px;
        }

        .input-row input {
            width: 80%;
            padding: 8px;
            font-size: 16px;
        }
        .input-row button {
            padding: 8px 16px;
            font-size: 16px;
        }
        .input-row button:disabled {
            background: #aaa;
            cursor: not-allowed;
        }

        /* –û–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–µ–∫—Ü–∏–π (—Ç–µ–∫—Å—Ç/—Ñ–æ—Ç–æ) */
        .stream-section {
            display: flex;
            flex-direction: column;
            flex: 1;

            background: #f5f7fb;                 /* –º—è–≥–∫–∏–π —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω */
            border: 1px solid #e1e5ee;           /* —Ç–æ–Ω–∫–∞—è —Ä–∞–º–∫–∞ */
            border-radius: 12px;
            padding: 15px 18px;
            margin-bottom: 20px;

            box-shadow: 0 4px 10px rgba(0,0,0,0.05);   /* –º—è–≥–∫–∞—è —Ç–µ–Ω—å */
        }

        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ—Ç–æ–∫–æ–≤ */
        .stream-section h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-weight: 600;
        }

        /* –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º—ã–µ –∑–æ–Ω—ã */
        .stream-box {
            height: 40vh;           /* üí° –≠–¢–û –í–ö–õ–Æ–ß–ê–ï–¢ –°–ö–†–û–õ–õ */
            overflow-y: auto;
            background: white;
            border-radius: 10px;
            padding: 10px;
            border: 1px solid #ccc;
        }

        /* –≠–ª–µ–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞ */
        .stream-item {
            background: #eef4ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* –§–æ—Ç–æ */
        .stream-image {
            width: 100%;
            max-width: 100%;
            border-radius: 12px;
            margin-bottom: 10px;

            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }

    </style>
</head>

<body>

<div class="layout">

    <!-- ---------------- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ ‚Äî –ß–ê–¢ ---------------- -->
    <div class="chat-container">

        <h2>üõçÔ∏è TINA - T-Intelligent assistant </h2>

        <div id="chat-box" class="chat-scroll"></div>

        <div class="status-box" id="status-box">
            <b>–°—Ç–∞—Ç—É—Å:</b>
            <span id="status-text">–æ–∂–∏–¥–∞–Ω–∏–µ...</span>
        </div>

    </div>

    <!-- ---------------- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ ‚Äî –°–¢–†–ò–ú ---------------- -->
    <div class="stream-container">
        <h2>üì° Stream</h2>

        <!-- –ë–ª–æ–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π -->
        <div class="stream-section">
            <h3>–≠–∫—Ä–∞–Ω</h3>
            <div id="stream-photo" class="stream-box"></div>
        </div>  <!-- ‚Üê –≠–¢–û–¢ –ó–ê–ö–†–´–í–ê–Æ–©–ò–ô DIV –£ –¢–ï–ë–Ø –û–¢–°–£–¢–°–¢–í–û–í–ê–õ -->

        <!-- –ë–ª–æ–∫ —Ç–µ–∫—Å—Ç–∞ -->
        <div class="stream-section">
            <h3>–ü–æ—Ç–æ–∫ –º—ã—Å–ª–µ–π</h3>
            <div id="stream-text" class="stream-box"></div>
    </div>

</div>


</div>

<!-- ===== –§–ò–ö–°–ò–†–û–í–ê–ù–ù–ê–Ø –ü–ê–ù–ï–õ–¨ –í–í–û–î–ê ===== -->
<div class="input-row">
    <input id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
    <button id="send-btn" onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>


<script>
let userId = "user_1";

function addMessage(sender, text) {
    const div = document.createElement("div");
    div.className = "msg " + sender;
    div.innerText = text;
    document.getElementById("chat-box").appendChild(div);

    // –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
    const box = document.getElementById("chat-box");
    box.scrollTop = box.scrollHeight;
}

function updateStatus(intentReply) {
    const status = intentReply.type;
    document.getElementById("status-text").innerText = status;

    if (status === "final") {
        document.getElementById("send-btn").disabled = true;
        document.getElementById("input").disabled = true;
        addMessage("bot", "üîç –ü–æ–∏—Å–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤... –û–∂–∏–¥–∞–π—Ç–µ.");
        runStream();
    }
}

async function send() {
    const btn = document.getElementById("send-btn");
    const input = document.getElementById("input");
    const text = input.value;

    if (!text) return;

    addMessage("user", text);
    input.value = "";
    btn.disabled = true;

    const res = await fetch("http://localhost:8000/chat", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ user_id: userId, text })
    });

    const data = await res.json();

    updateStatus(data.reply);

    let replyText = "";

    if (data.reply.type === "clarification") {
        replyText = "ü§ñ –£—Ç–æ—á–Ω–µ–Ω–∏–µ: " + data.reply.question;
    } 
    else if (data.reply.type === "not_relevant") {
        replyText = "‚ö†Ô∏è –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ: " + data.reply.message;
    }
    else if (data.reply.type === "final") {
        replyText = "üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:\n" +
                    JSON.stringify(data.reply.products, null, 2);
    } 
    else {
        replyText = JSON.stringify(data.reply, null, 2);
    }

    addMessage("bot", replyText);

    if (data.reply.type !== "final") {
        btn.disabled = false;
    }
}



function addStreamText(text) {
    const box = document.getElementById("stream-text");
    const div = document.createElement("div");
    div.className = "stream-item";
    div.innerText = text;
    box.appendChild(div);

    // –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
    box.scrollTop = box.scrollHeight;
}

function addStreamPhoto(url) {
    const box = document.getElementById("stream-photo");
    const img = document.createElement("img");
    img.className = "stream-image";
    img.src = url;
    box.appendChild(img);
    box.scrollTop = box.scrollHeight;
}



async function runStream() {

    addStreamText("‚è≥ –°—Ç—Ä–∏–º –∑–∞–ø—É—â–µ–Ω. –ñ–¥—ë–º –∞–≥–µ–Ω—Ç–∞...");

    const resp = await fetch("http://localhost:8000/agent/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId })
    });

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();

    let buffer = "";

    while (true) {

        const { value, done } = await reader.read();

        if (done) {
            addStreamText("‚èπ –°—Ç—Ä–∏–º –∑–∞–≤–µ—Ä—à—ë–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.");
            break;
        }

        buffer += decoder.decode(value, { stream: true });

        let lines = buffer.split("\n");
        buffer = lines.pop();

        for (let line of lines) {

            if (!line.trim()) continue;

            let event;
            try {
                event = JSON.parse(line);
            } catch (err) {
                addStreamText("‚ö† –ü–ª–æ—Ö–æ–π JSON: " + line);
                continue;
            }

            if (event.type === "text") {
                addStreamText(event.content);
            }

            else if (event.type === "image") {
                addStreamPhoto(event.content);

            }

            else if (event.type === "status" && event.content === "end") {
                addStreamText("‚úî –ö–∞–Ω–¥–∏–¥–∞—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω.");
                return;
            }
        }
    }
}


</script>
</body>
</html>
